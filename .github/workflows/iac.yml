# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Infrastructure as Code Pipeline - AKS Deployment
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# This workflow handles:
# - Terraform validation, formatting, and security scanning
# - Multi-environment plan/apply with manual approval gates
# - Drift detection on schedule
#
# Required GitHub Secrets:
# - ARM_CLIENT_ID: Azure Service Principal Client ID
# - ARM_CLIENT_SECRET: Azure Service Principal Client Secret
# - ARM_SUBSCRIPTION_ID: Azure Subscription ID
# - ARM_TENANT_ID: Azure AD Tenant ID
# - STATE_ACCESS_KEY: Azure Storage Account access key for tfstate
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: Infrastructure as Code

on:
  pull_request:
    branches: [main]
    paths:
      - '*.tf'
      - 'modules/**'
      - 'environments/**'
      - '.github/workflows/iac.yml'
  
  push:
    branches: [main]
    paths:
      - '*.tf'
      - 'modules/**'
      - 'environments/**'
      - '.github/workflows/iac.yml'
  
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply

concurrency:
  group: iac-dev-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

env:
  TF_VERSION: '1.7.0'
  # Azure credentials from secrets
  ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# JOBS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Validate Terraform
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  validate:
    name: Validate
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Format Check
        run: terraform fmt -check -recursive -diff

      - name: Initialize (validation only)
        run: terraform init -backend=false

      - name: Validate
        run: terraform validate

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Security Scan
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: .
          framework: terraform
          soft_fail: true
          skip_check: CKV_TF_1,CKV_TF_2
          output_format: cli

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Plan Infrastructure (Dev Only)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  plan:
    name: Plan [dev]
    runs-on: ubuntu-latest
    needs: [validate, security-scan]
    if: |
      always() &&
      needs.validate.result == 'success' &&
      (needs.security-scan.result == 'success' || needs.security-scan.result == 'failure')
    
    permissions:
      contents: read
      pull-requests: write

    outputs:
      plan_exit_code: ${{ steps.plan.outputs.exitcode }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Initialize
        run: |
          terraform init \
            -backend-config="storage_account_name=stiacstatedev" \
            -backend-config="container_name=tfstate" \
            -backend-config="key=dev/terraform.tfstate" \
            -backend-config="access_key=${{ secrets.STATE_ACCESS_KEY }}"

      - name: Plan
        id: plan
        continue-on-error: true
        run: |
          set +e
          terraform plan \
            -var-file="environments/dev.tfvars" \
            -out=tfplan-dev \
            -detailed-exitcode \
            -no-color 2>&1 | tee plan-output.txt
          
          EXIT_CODE=$?
          echo "exitcode=$EXIT_CODE" >> $GITHUB_OUTPUT
          
          # Exit codes: 0 = no changes, 1 = error, 2 = changes present
          if [[ $EXIT_CODE -eq 1 ]]; then
            echo "âŒ Plan failed"
            exit 1
          fi

      - name: Create plan metadata
        run: |
          cat > tfplan-dev.meta.json << EOF
          {
            "commit_sha": "${{ github.sha }}",
            "environment": "dev",
            "created_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "created_by": "${{ github.actor }}",
            "workflow_run_id": "${{ github.run_id }}",
            "has_changes": ${{ steps.plan.outputs.exitcode == '2' && 'true' || 'false' }}
          }
          EOF

      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-dev-${{ github.run_id }}
          path: |
            tfplan-dev
            tfplan-dev.meta.json
            plan-output.txt
          retention-days: 7

      - name: Comment Plan on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const planOutput = fs.readFileSync('plan-output.txt', 'utf8');
            const exitCode = '${{ steps.plan.outputs.exitcode }}';
            
            let status = 'âœ… No changes';
            if (exitCode === '2') status = 'âš ï¸ Changes detected';
            if (exitCode === '1') status = 'âŒ Plan failed';
            
            const truncated = planOutput.length > 60000 
              ? planOutput.substring(0, 60000) + '\n\n... (truncated)'
              : planOutput;
            
            const body = `## Terraform Plan: \`dev\` ${status}
            
            <details>
            <summary>Click to expand plan output</summary>
            
            \`\`\`hcl
            ${truncated}
            \`\`\`
            
            </details>
            
            *Commit: ${{ github.sha }}*
            *Workflow: [Run #${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*
            `;
            
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(c => 
              c.user.login === 'github-actions[bot]' && 
              c.body.includes(`Terraform Plan: \`dev\``)
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Apply Infrastructure (Manual Dispatch Only)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  apply:
    name: Apply [dev]
    runs-on: ubuntu-latest
    needs: plan
    if: |
      github.event_name == 'workflow_dispatch' && 
      github.event.inputs.action == 'apply'
    
    environment: 
      name: dev-apply
      url: https://portal.azure.com
    
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Download Plan
        uses: actions/download-artifact@v4
        with:
          name: tfplan-dev-${{ github.run_id }}
          path: .

      - name: Verify Plan Freshness
        run: |
          if [[ ! -f "tfplan-dev.meta.json" ]]; then
            echo "âŒ Plan metadata not found. Cannot verify plan freshness."
            exit 1
          fi
          
          PLAN_SHA=$(jq -r '.commit_sha' "tfplan-dev.meta.json")
          
          echo "Plan commit: $PLAN_SHA"
          echo "Current commit: ${{ github.sha }}"
          
          if [[ "$PLAN_SHA" != "${{ github.sha }}" ]]; then
            echo "âŒ Plan is STALE. Re-run with action=plan first."
            exit 1
          fi
          
          echo "âœ… Plan is fresh"

      - name: Initialize
        run: |
          terraform init \
            -backend-config="storage_account_name=stiacstatedev" \
            -backend-config="container_name=tfstate" \
            -backend-config="key=dev/terraform.tfstate" \
            -backend-config="access_key=${{ secrets.STATE_ACCESS_KEY }}"

      - name: Apply
        run: |
          echo "ðŸš€ Applying infrastructure changes to dev..."
          terraform apply -auto-approve "tfplan-dev"

      - name: Summary
        run: |
          echo "## âœ… Apply Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** dev" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Applied by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Quality Gate
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [validate, security-scan, plan]
    if: always() && github.event_name != 'schedule'

    steps:
      - name: Evaluate Results
        run: |
          echo "## IaC Quality Gate Results" >> $GITHUB_STEP_SUMMARY
          
          FAILED=false
          
          if [[ "${{ needs.validate.result }}" == "success" ]]; then
            echo "âœ… Validation passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Validation failed" >> $GITHUB_STEP_SUMMARY
            FAILED=true
          fi
          
          if [[ "${{ needs.security-scan.result }}" == "success" ]]; then
            echo "âœ… Security scan passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Security scan has warnings" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.plan.result }}" == "success" ]]; then
            echo "âœ… Terraform plan succeeded" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Terraform plan failed" >> $GITHUB_STEP_SUMMARY
            FAILED=true
          fi
          
          if [[ "$FAILED" == "true" ]]; then
            echo "### âŒ Quality Gate Failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "### âœ… All Quality Gates Passed" >> $GITHUB_STEP_SUMMARY
          fi
